{
  "$schema": "https://aka.ms/codetour-schema",
  "title": "6 - Scaling with Azure Infrastructure",
  "description": "Deploy AI agents to Azure with Bicep IaC. Learn Azure Functions Flex, Cosmos DB serverless, and managed identity security.",
  "nextTour": "7 - Governance & Observability",
  "steps": [
    {
      "title": "Cloud Infrastructure",
      "description": "## Modern Cloud Infrastructure ğŸ—ï¸\n\nThis tour covers the **infrastructure layer**â€”how to deploy and scale your AI agents.\n\n---\n\n### Our Azure Architecture\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                    AZURE RESOURCES                          â”‚\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚  ğŸ¤– Agent API        â†’  Azure Functions (Flex Consumption)  â”‚\nâ”‚  ğŸ”Œ MCP Server       â†’  Azure Functions (Flex Consumption)  â”‚\nâ”‚  ğŸ” Burger API       â†’  Azure Functions (Flex Consumption)  â”‚\nâ”‚  ğŸŒ Web Apps         â†’  Static Web Apps                     â”‚\nâ”‚  ğŸ—„ï¸ Database         â†’  Cosmos DB NoSQL                     â”‚\nâ”‚  ğŸ§  AI Model         â†’  Azure OpenAI (GPT-4o)               â”‚\nâ”‚  ğŸ“Š Monitoring       â†’  Application Insights                â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n---\n\n### What We'll Cover:\n\n1. **Infrastructure as Code** - Bicep templates\n2. **Serverless Architecture** - Azure Functions Flex Consumption\n3. **Data Storage** - Cosmos DB configuration\n4. **AI Services** - Azure OpenAI integration\n5. **Deployment** - Azure Developer CLI\n"
    },
    {
      "file": "infra/main.bicep",
      "line": 1,
      "selection": {
        "start": {
          "line": 1,
          "character": 1
        },
        "end": {
          "line": 22,
          "character": 2
        }
      },
      "title": "Bicep: Infrastructure as Code",
      "description": "\n## Bicep Templates ğŸ“œ\n\n### What is Bicep?\n\n**Bicep** is Azure's domain-specific language for deploying resources.\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚  âœ… Declarative     â†’  Describe WHAT you want               â”‚\nâ”‚  âœ… Type-safe       â†’  Compile-time validation              â”‚\nâ”‚  âœ… Modular         â†’  Reusable components                  â”‚\nâ”‚  âœ… Repeatable      â†’  Same result every deployment         â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n### Parameter Decorators\n\n| Decorator | Purpose |\n|-----------|----------|\n| `@minLength` | Validation constraint |\n| `@maxLength` | Validation constraint |\n| `@description` | Documentation |\n| `param` | Input value definition |\n\n---\n\n### Choosing the Right Azure Regions ğŸŒ\n\nNotice how we restrict deployment regions:\n\n```bicep\n@allowed([\n  'northeurope'\n  'uksouth'\n  'eastus'\n  'eastus2'\n  'southcentralus'\n  'westus2'\n  'australiaeast'\n])\nparam location string\n```\n\n### Why Restrict Regions?\n\nSome. resources, like **Azure Functions Flex Consumption** are only available in specific regions!\n\n**Consider**:\n1. **User location** - Deploy close to users for low latency\n2. **Feature availability** - Not all services in all regions\n3. **Compliance** - GDPR might require EU regions (Data residency)\n4. **Cost** - Some regions cost more\n\n**Challenges**:\n- **Data synchronization** - Cosmos DB multi-region writes\n- **Cost** - 2x infrastructure\n- **Complexity** - More moving parts\n\n---\n\n### Unique Resource Naming\n\nNotice how we generate unique names:\n\n```bicep\nvar abbrs = loadJsonContent('abbreviations.json')\nvar resourceToken = toLower(uniqueString(subscription().id, environmentName, location))\nvar tags = { 'azd-env-name': environmentName }\n```\n\n**Result**: `func-burger-api-abc123xyz`\n\n### Components\n\n| Part | Example | Purpose |\n|------|---------|----------|\n| Prefix | `func-` | Azure abbreviation |\n| Name | `burger-api` | Human-readable |\n| Token | `abc123xyz` | Unique per environment |\n\n### Why Unique Names & Tagging?\n\nSome Azure resources require **globally unique** names:\n- Storage accounts\n- Cosmos DB accounts\n- Static Web Apps URLs\n\nAll resources get tagged for:\n- ğŸ’° Cost tracking (filter by environment)\n- ğŸ“ Resource grouping\n- ğŸ”§ Azure Developer CLI integration"
    },
    {
      "file": "infra/main.bicep",
      "description": "## Declaring Cloud Resources with Modules\n\nYou describeÂ WHATÂ you want, notÂ HOWÂ to create it:\n\n```bicep\nmodule burgerApiFunction 'br/public:avm/res/web/site:0.16.1' = {\n  name: 'burger-api'\n  params: {\n    kind: 'functionapp,linux'\n    ...\n\nmodule cosmosDb 'br/public:avm/res/document-db/database-account:0.16.0' = {\n  params: {\n    capabilitiesToAdd: [\n      'EnableServerless'\n      'EnableNoSQLVectorSearch'\n    ]\n    sqlDatabases: [\n        ...\n\nmodule aiFoundry 'br/public:avm/ptn/ai-ml/ai-foundry:0.4.0' = {\n  params: {\n    aiModelDeployments: [\n      {\n\nmodule storageRoleBurgerApi 'br/public:avm/ptn/authorization/resource-role-assignment:0.1.2' = {\n  params: {\n    principalId: burgerApiFunction.outputs.systemAssignedMIPrincipalId\n    roleName: 'Storage Blob Data Contributor'\n    roleDefinitionId: 'b7e6dc6d-f1e8-4753-8033-0f276bb0955b'\n    resourceId: storage.outputs.resourceId\n  }\n}\n```\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚  INPUT (params)                                      â”‚\nâ”‚  â€¢ name                                              â”‚\nâ”‚  â€¢ location                                          â”‚\nâ”‚  â€¢ managedIdentities                                 â”‚\nâ”‚  â€¢ configs                                           â”‚\nâ”‚       â†“â†“â†“                                            â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚\nâ”‚  â”‚  Azure Module (AVM)                             â”‚ â”‚\nâ”‚  â”‚  'br/public:avm/res/web/site:0.16.1'            â”‚ â”‚\nâ”‚  â”‚  (Reusable component from Azure registry)       â”‚ â”‚\nâ”‚  â”‚                                                 â”‚ â”‚\nâ”‚  â”‚  Creates: Function App + App Service Plan       â”‚ â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚\nâ”‚       â†“â†“â†“                                            â”‚\nâ”‚  OUTPUT (results)                                    â”‚\nâ”‚  â€¢ outputs.name                                      â”‚\nâ”‚  â€¢ outputs.resourceId                                â”‚\nâ”‚  â€¢ outputs.systemAssignedMIPrincipalId               â”‚\nâ”‚  â€¢ outputs.defaultHostname                           â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\nFor example, Bicep handles:\n* Creating the Function App resource\n* Configuring runtime\n* Setting up monitoring\n* Network security\n* Identity configuration\n\nYou just declareÂ what you need, and the module implements it.\n\nAfter resources deploy, their outputs becomeÂ environment variablesÂ for functions. Your function code then uses:\n```typescript\nconst endpoint = process.env.AZURE_COSMOSDB_NOSQL_ENDPOINT;\nconst cosmosClient = new CosmosClient({ endpoint, credential });\n```\n\n### Managed Identity Pattern\n\n```bicep\n    functionAppConfig: {\n      deployment: {\n        storage: {\n          type: 'blobContainer'\n          value: '${storage.outputs.primaryBlobEndpoint}${burgerMcpResourceName}'\n          authentication: {\n            type: 'SystemAssignedIdentity'\n          }\n```\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚  Function App                                               â”‚\nâ”‚      â†“                                                      â”‚\nâ”‚  System Assigned Managed Identity                           â”‚\nâ”‚      â†“                                                      â”‚\nâ”‚  RBAC Role Assignment                                       â”‚\nâ”‚      â†“                                                      â”‚\nâ”‚  Resource Access (Storage, Cosmos DB, OpenAI)               â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n| Traditional | With Managed Identity |\n|-------------|----------------------|\n| Connection strings | Identity-based auth |\n| Manual key rotation | Automatic |\n| Secrets in config | No secrets anywhere |\n| Security risk | Zero-trust |\n\n### Why This Pattern?\n\n| Benefit Impact | Impact |\n|-------------|----------------------|\n| No manual wiring |Outputs auto-connect as inputs|\n| Safe refactoring |Rename a resource, everything updates|\n| Reproducible| Deploy 100 times, same result|\n| Testable| Mock modules for testing|\n| No secrets in code| Managed Identity handles auth|\n| Version control| Track all infra changes like code|\n",
      "line": 99
    },
    {
      "file": "azure.yaml",
      "line": 1,
      "selection": {
        "start": {
          "line": 1,
          "character": 1
        },
        "end": {
          "line": 45,
          "character": 1
        }
      },
      "title": "Azure Developer CLI Configuration",
      "description": "## Deploying with Azure Developer CLI (azd) ğŸš€\n\nThe `azure.yaml` file defines our deployment strategy:\n\n### What is azd?\n\n**Azure Developer CLI (azd)** = Tool for provisioning and deploying entire projects to Azure\n\n**Single command** deployment:\n```bash\nazd up\n```\n\n**What it does**:\n1. Provisions infrastructure (Bicep)\n2. Builds code (npm run build)\n3. Deploys services (Azure Functions, Static Web Apps)\n4. Configures environment variables\n5. Shows you the URLs\n\n---\n\n### The azd Workflow\n\n```bash\n# First time setup\nazd auth login          # Login to Azure\nazd init                # Initialize config\nazd up                  # Deploy everything\n\n# After code changes\nazd deploy              # Deploy code only (faster)\n\n# View logs\nazd monitor             # Open Application Insights\n\n# Clean up\nazd down --purge        # Delete all resources\n```\n\n---\n\n### Service Types & Definitions\n\n| Host Type | Use Case | Deployment |\n|-----------|----------|------------|\n| **azurefunctions** | Backend APIs, MCP servers | Zip deployment |\n| **staticwebapp** | Frontend SPAs | Static file hosting |\n| **containerapp** | Dockerized apps | Container deployment |\n| **appservice** | Traditional web apps | Code or container |\n\n**We use**:\n- `azurefunctions` for APIs (serverless, auto-scale)\n- `staticwebapp` for frontends (CDN, free SSL)\n\n| Property | Purpose | Example |\n|----------|----------|----------|\n| `project` | Source code location | `./packages/burger-api` |\n| `language` | Build configuration | `ts` (TypeScript) |\n| `host` | Azure service type | `function`, `staticwebapp` |\n| `dist` | Build output folder | `dist` |\n"
    }
  ]
}